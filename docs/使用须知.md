# NetMate 使用须知

## WiFi 自动重连说明

### 首次连接要求（Windows）

**NetMate的WiFi自动重连功能需要在Windows系统中已保存的WiFi配置文件。**

#### 为什么需要手动连接一次？

Windows系统的WiFi配置文件包含以下信息：
- SSID（WiFi名称）
- 加密方式（WPA2、WPA3等）
- 密码（加密存储）
- 网络认证协议（SAE、PSK等）

不同的WiFi路由器可能使用不同的加密方式：
- **WPA2-个人**：传统加密方式
- **WPA3-个人**：新一代更安全的加密协议
- **WPA3/WPA2混合模式**：同时支持两种方式

**Windows命令行工具（netsh）无法自动创建正确的WiFi配置文件**，特别是对于使用WPA3加密的WiFi。只有Windows图形界面能够正确协商加密方式并保存配置。

#### 解决方案

**首次使用前，请在Windows系统中手动连接一次WiFi：**

1. 打开 Windows 设置 → 网络和Internet → WiFi
2. 找到目标WiFi网络，点击"连接"
3. 输入WiFi密码
4. 连接成功后，Windows会自动保存配置

**之后，NetMate就可以正常使用该WiFi配置进行自动重连了。**

#### 技术实现

NetMate使用Windows已保存的WiFi配置文件进行连接：

```bash
# 检查配置文件是否存在
netsh wlan show profile name="WiFi名称"

# 使用已保存的配置连接
netsh wlan connect name="WiFi名称"
```

这种方式：
- ✅ 保留Windows协商的所有加密设置（WPA2/WPA3）
- ✅ 支持所有加密方式
- ✅ 兼容性最好
- ❌ 需要手动连接一次创建配置文件

### macOS 和 Linux

macOS和Linux平台支持直接使用SSID和密码连接WiFi，无需手动连接。

- **macOS**: 使用 `networksetup -setairportnetwork` 命令
- **Linux**: 使用 `nmcli dev wifi connect` 命令

### 如何查看WiFi加密方式（Windows）

在PowerShell中运行：

```powershell
netsh wlan show profile name="你的WiFi名称" key=clear
```

查看"安全设置"部分：

```
安全设置
-----------------
    身份验证         : WPA3 - 个人      ← WPA3加密
    密码             : GCMP-256
    身份验证         : WPA2 - 个人      ← 同时支持WPA2
    密码             : CCMP
```

或者：

```
安全设置
-----------------
    身份验证         : WPA2 - 个人      ← 纯WPA2加密
    加密             : CCMP
```

---

## 心跳检测与自动重连配置说明

### 功能关系

NetMate提供两个重要的网络监控功能，它们相互配合以保证网络连接的稳定性：

#### 心跳检测（`enableHeartbeat`）

**作用：发现问题**
- 定期检测网络连接状态和校园网认证状态
- 检测频率由"轮询间隔"（`pollingInterval`）控制，默认30秒
- 相当于应用的"眼睛"，持续监控网络健康状况

**工作原理：**
```
启动应用 → 启用心跳检测 → 每30秒检测一次
                            ↓
                  检查能否访问互联网
                            ↓
                  将状态广播给应用和重连服务
```

#### 自动重连（`autoReconnect`）

**作用：解决问题**
- 当检测到网络从"已连接"变为"断开"时，自动重新登录校园网
- 最多重试3次，使用指数退避策略（2秒 → 4秒 → 8秒）
- 相当于应用的"手"，自动修复网络问题

**触发条件：**
- 网络状态必须从"已连接"变为"断开"
- 需要配置了账户信息
- 必须能够获取本机IP地址

### 配置组合效果

| 心跳检测 | 自动重连 | 效果说明 |
|---------|---------|---------|
| ✅ 启用 | ✅ 启用 | **推荐配置** - 每30秒检测网络，发现断线立即自动重连 |
| ✅ 启用 | ❌ 禁用 | 能及时发现网络断开，但不会自动修复，需要手动点击"登录" |
| ❌ 禁用 | ✅ 启用 | **不推荐** - 只在启动时检测一次，无法及时发现断线，自动重连功能基本无法触发* |
| ❌ 禁用 | ❌ 禁用 | 只在启动时检测一次，不主动监控和修复网络 |

> *注：即使禁用心跳检测，应用仍有WiFi事件监听器会在WiFi切换时触发检测，但无法检测到"校园网认证失效"的情况。

### 使用建议

#### 推荐配置（桌面版）

```
✅ 启用心跳检测
✅ 启用自动重连
⏱️ 轮询间隔：30秒（默认值）
```

**适用场景：**
- 校园网经常自动断线
- 需要长期保持在线（下载、游戏等）
- 不想手动重连

**优点：**
- 无感知自动修复网络问题
- 及时发现校园网认证失效
- 提升使用体验

**缺点：**
- 后台持续运行，占用少量系统资源
- 会定期发送网络请求（每30秒访问baidu.com等检测网站）

#### 省电配置（移动版）

```
✅ 启用自动重连
⏱️ 轮询间隔：60秒或更长
```

**适用场景：**
- 笔记本电池供电
- 移动设备需要省电

**说明：**
- 延长检测间隔可以降低功耗
- 发现断线的速度会变慢

#### 手动模式

```
❌ 禁用心跳检测
❌ 禁用自动重连
```

**适用场景：**
- 只是偶尔需要登录校园网
- 不想应用在后台运行
- 担心隐私（不希望定期访问外部网站）

**说明：**
- 完全由用户手动控制登录
- 应用只在启动时检测一次网络状态

### 工作流程示例

#### 场景1：心跳检测发现断线并自动重连

```
1. [00:00] 应用启动，启用心跳检测（30秒间隔）
2. [00:00] 首次检测：已连接，认证成功
3. [00:30] 第1次心跳检测：已连接
4. [01:00] 第2次心跳检测：已连接
5. [01:30] 第3次心跳检测：无法访问互联网 ⚠️
          └→ 状态变化：已连接 → 断开
          └→ 触发自动重连服务
6. [01:30] 自动重连第1次尝试...
7. [01:31] 登录成功 ✅
8. [02:00] 第4次心跳检测：已连接（确认恢复）
```

#### 场景2：禁用心跳检测，WiFi切换触发重连

```
1. [00:00] 应用启动，禁用心跳检测
2. [00:00] 首次检测：已连接
3. [01:00] （期间校园网认证失效，但应用不知道）
4. [02:00] 用户切换WiFi网络
5. [02:01] WiFi事件监听器检测到SSID变化
          └→ 触发网络状态检测
          └→ 发现需要认证，触发自动重连
6. [02:02] 登录成功 ✅
```

### 技术实现参考

心跳检测和自动重连的集成代码：

```typescript
// 心跳检测回调
const statusCallback = async (status: NetworkStatus) => {
  // 1. 广播状态给所有窗口（更新UI）
  broadcastToAllWindows('network:statusChanged', status);

  // 2. 传递给自动重连服务处理
  if (autoReconnectService) {
    await autoReconnectService.handleStatusChange(status);
  }
};

// 启动心跳检测（如果启用）
if (enableHeartbeat) {
  networkDetector.startPolling(statusCallback, {
    interval: pollingInterval,  // 例如 30000ms
    immediate: true             // 启动时立即检测一次
  });
}
```

自动重连服务判断逻辑：

```typescript
async handleStatusChange(status: NetworkStatus) {
  const wasConnected = this.lastStatus?.connected ?? false;
  const isDisconnected = !status.connected;

  // 检测到从"已连接"变为"断开"，触发重连
  if (wasConnected && isDisconnected) {
    await this.attemptReconnect();
  }

  this.lastStatus = status;
}
```

---

## 常见问题

### Q: 为什么应用不能自动创建WiFi配置？

A: Windows的 `netsh wlan` 命令工具对现代WiFi加密协议（特别是WPA3）的支持非常有限。即使尝试自动创建配置文件，也可能因为加密方式不匹配导致连接失败。只有Windows图形界面能够完整支持所有加密方式的自动协商。

### Q: 手动连接一次后，配置会一直保留吗？

A: 是的。除非你在Windows中手动删除该WiFi配置，或者使用"忘记此网络"功能，否则配置会一直保留。

### Q: 如果我的WiFi只用WPA2，还需要手动连接吗？

A: 是的，仍然需要。虽然理论上可以通过命令创建WPA2配置文件，但实践中发现存在字符编码、参数兼容性等各种问题，导致可靠性很低。手动连接一次是最稳定的方案。

### Q: 我更换了WiFi密码怎么办？

A: 在Windows中重新连接一次WiFi，输入新密码，Windows会自动更新配置文件。之后NetMate会使用新的配置。

### Q: macOS和Linux也需要手动连接一次吗？

A: 不需要。macOS和Linux的网络管理工具支持直接使用SSID和密码连接，无需预先保存配置。

### Q: 心跳检测会消耗很多流量吗？

A: 不会。每次心跳检测只发送一个轻量级的HTTP HEAD请求（约200-500字节），每30秒一次相当于每小时约36KB流量，几乎可以忽略不计。

### Q: 为什么启用了自动重连但没有自动登录？

A: 可能的原因：
1. **未启用心跳检测** - 应用无法及时发现网络断开，建议同时启用心跳检测
2. **账户未配置** - 需要先添加并选择一个账户
3. **网络状态未变化** - 自动重连只在检测到"从已连接变为断开"时触发

### Q: 可以让应用保持后台运行但不检测网络吗？

A: 可以。在设置中：
- 开启"开机自启动"（让应用在后台运行）
- 关闭"心跳检测"（不主动检测网络）
- 开启"自动重连"（WiFi切换时仍会触发重连）

这样应用会保持在托盘，只在你切换WiFi时才会检测和重连。

### Q: 心跳检测访问哪些网站？会泄露隐私吗？

A: 心跳检测依次尝试访问以下国内网站（仅访问首页判断连通性）：
1. https://www.baidu.com
2. https://www.speedtest.cn
3. http://connectivitycheck.platform.hicloud.com/generate_204

这些都是公开的检测服务，不会发送任何个人信息或账户数据。如果担心隐私，可以关闭心跳检测。

---

## 其他注意事项

### 网络状态检测

- 应用每3秒检测一次WiFi连接状态
- WiFi断开后，会等待2秒后自动尝试重连
- 重连成功后，会等待3秒让网络稳定，然后更新状态

### 日志查看

- **应用内日志**：在"运行日志"页面查看简洁的操作记录
- **错误提示**：如果WiFi配置文件不存在，应用会提示需要手动连接

### 中文WiFi名称支持

目前应用对中文SSID的支持有限，可能会遇到编码问题。建议：
- 优先使用英文或数字作为WiFi名称
- 如果必须使用中文SSID，请确保已在Windows中手动连接过

---

*最后更新: 2026-01-04*
